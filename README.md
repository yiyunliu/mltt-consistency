# Mechanized consistency proof for MLTT
This repository contains a very short consistency proof of Martin-LÃ¶f
type theory in Coq (< 1000 LoC excluding code produced by autosubst2). You need
[Autosubst2](https://github.com/uds-psl/autosubst2) (only if
you plan to change [syntax.sig](syntax.sig)),
[stdpp](https://gitlab.mpi-sws.org/iris/stdpp), [Coq-Equations](https://github.com/mattam82/Coq-Equations),
and [CoqHammer](https://github.com/lukaszcz/coqhammer) to build the
project.

The repository is known to compile with Coq 8.18.0. It
won't compile with earlier versions because I'm using a feature
related to universe unification that wasn't introduced until
8.18.0. If you annotate terms whose type involves `Prop`, then you
might be able to compile the code with an older Coq version.

The semantic interpretation is heavily inspired by
<https://dl.acm.org/doi/10.1145/3167091>. However, we leverage
impredicativity to define a countable universe hierarchy, rather than
defining a single predicative universe, where impredicativity turns
out to be unnecessary (see <https://dl.acm.org/doi/10.1145/3636501.3636951>).

## Language specification
The syntactic typing rules can be found in [typing.v](typing.v).

## Install dependencies
The [opam.switch](opam.switch) file allows you to recreate an opam
switch that is identical to our environment. To create a switch named `mltt`, run the following command when you have [opam.switch](opam.switch) available in your working directory:
```
opam update
opam switch import opam.switch --switch mltt --repositories=coq-released=https://coq.inria.fr/opam/released,default=https://opam.ocaml.org
```

## Build
Simply run the following command:
```sh
make
```

## Axioms
Both syntactic and semantic soundness proofs rely on functional
extensionality because it is required by the Autosubst 2
infrastructure.

The semantic soundness proof additionally requires propositional
extensionality. Propositional extensionality is not neccesssary, but
it makes automation more tractable.

The repository is otherwise free of axioms. Notably, manual
generalization is favored over the `dependent induction` tactic to avoid
reliance on axioms related to proof irrelevance.


## Contents 

```
  beta/axioms.v   - funext, from autosubst library
  beta/imports.v  - library dependencies

* Section 2
  beta/syntax.v   - Fig 1. generated by autosubst
  beta/unscoped.v - autosubst library
  beta/join.v     - Fig 2. parallel reduction and its properties
  beta/typing.v   - Fig 3. specification of the type system

* Section 3 
  beta/semtyping.v - Fig 4. definition of logical relation

* Section 4
  beta/soundness.v - semantic typing, semantic soundness, consistency

* Section 5
  beta/normalform.v     - normal and neutral terms, antirenaming lemma
  beta/semtypingopen.v  - logical relation for open terms
  beta/soundnessopen.v  - soundness of open terms, normalizing

* Section 6
  eta/*            - same development but with eta extension

* Other
  beta/syntactic_soundness.v - preservation & progress
```

## Statistics

Consistency including only beta rules:

```
github.com/AlDanial/cloc v 2.02  T=0.02 s (288.0 files/s, 63322.4 lines/s)
-------------------------------------------------------------------------------
File                             blank        comment           code
-------------------------------------------------------------------------------
./join.v                            89             58            344
./semtyping.v                       64             38            338
./soundness.v                       17             28            192
./typing.v                          23             15             83
./syntax.sig                         1              0             14
./imports.v                          3              0             12
-------------------------------------------------------------------------------
SUM:                               197            139            983
-------------------------------------------------------------------------------
```

Normalization including only beta rules:

```
github.com/AlDanial/cloc v 2.02  T=0.02 s (309.8 files/s, 77705.9 lines/s)
-------------------------------------------------------------------------------
File                             blank        comment           code
-------------------------------------------------------------------------------
./semtypingopen.v                   69             34            430
./join.v                            89             58            344
./normalform.v                      37             21            273
./soundnessopen.v                   13             26            211
./typing.v                          23             15             83
./syntax.sig                         1              0             14
./imports.v                          3              0             12
-------------------------------------------------------------------------------
SUM:                               235            154           1367
-------------------------------------------------------------------------------
```

Normalization include beta and eta rules:

```
github.com/AlDanial/cloc v 2.02  T=0.02 s (414.4 files/s, 118110.2 lines/s)
-------------------------------------------------------------------------------
File                             blank        comment           code
-------------------------------------------------------------------------------
./join.v                            99             64            614
./semtyping.v                       69             34            430
./normalform.v                      34             18            230
./soundness.v                       13             26            211
./typing.v                          23             15             83
./imports.v                          3              0             14
./syntax.sig                         1              0             14
-------------------------------------------------------------------------------
SUM:                               242            157           1596
-------------------------------------------------------------------------------
```

All counts above exclude files generated by Autosubst,
i.e. axioms.v, unscoped.v, and syntax.v.